<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using butterfly in an operational data pipeline • butterfly</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using butterfly in an operational data pipeline">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">butterfly</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/butterfly.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/butterfly_in_pipeline.html">Using butterfly in an operational data pipeline</a></li>
    <li><a class="dropdown-item" href="../articles/butterfly_paper.html">butterfly: An R package for the verification of continually updating timeseries data where we expect new values, but want to ensure previous data remains unchanged.</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/antarctica/butterfly/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using butterfly in an operational data pipeline</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/antarctica/butterfly/blob/main/vignettes/articles/butterfly_in_pipeline.Rmd" class="external-link"><code>vignettes/articles/butterfly_in_pipeline.Rmd</code></a></small>
      <div class="d-none name"><code>butterfly_in_pipeline.Rmd</code></div>
    </div>

    
    
<style>
p.caption {
font-size: 0.6em;
}
</style>
<p>This article is a <strong>simplified</strong> demonstration of a real
operational data pipeline we are implementing at the British Antarctic
Survey called asli-pipeline. You can inspect the full source code of
this pipeline in the repository: <a href="https://github.com/antarctica/asli-pipeline" class="external-link">asli-pipeline
repository</a> (Zwagerman &amp; Wilby).</p>
<p>This package was originally developed to deal with <a href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels?tab=documentation" class="external-link">ERA5</a>’s
initial release data, <strong>ERA5T</strong>. ERA5T data for a month is
overwritten with the final ERA5 data two months after the month in
question.</p>
<p>Usually ERA5 and ERA5T are identical, but occasionally an issue with
input data can (for example for <a href="https://confluence.ecmwf.int/display/CKB/ERA5T+issue+in+snow+depth" class="external-link">09/21
- 12/21</a>, and <a href="https://forum.ecmwf.int/t/final-validated-era5-product-to-differ-from-era5t-in-july-2024/6685" class="external-link">07/24</a>)
force a recalculation, meaning previously published data differs from
the final product.</p>
<p>In a pipeline that generates ERA5-derived data, and continually
updates and <strong>publishes</strong> this data, we therefore need to
robustly ensure that previous ERA5 data changing does not affect our
published outputs.</p>
<div class="section level2">
<h2 id="pipeline-overview">Pipeline overview<a class="anchor" aria-label="anchor" href="#pipeline-overview"></a>
</h2>
<p>Consider a classic input/output (I/O) data pipeline where we read in
data from an external source, perform some sort of calculation to it,
and transfer the output to a different location.</p>
<div class="figure" style="text-align: center">
<img src="img%2Fsimple_diagram.png" alt="A simple diagram showing the steps in a generic data pipeline." width="100%"><p class="caption">
A simple diagram showing the steps in a generic data pipeline.
</p>
</div>
<p>We use a pipeline to calculate the <strong>‘Amundsen Sea Low
Index’</strong>, or ASLI. The Amundsen Seas Low (ASL) is a highly
dynamic and mobile climatological low pressure system located in the
Pacific sector of the Southern Ocean. If you are interested in ASLI, and
why these values are significant for environmental forecasting, please
refer to <a href="https://doi.org/10.1002/2015GL067143" class="external-link">Hosking et
al. (2016)</a>.</p>
<p>In our case, we run this pipeline on a monthly basis:</p>
<div class="figure" style="text-align: center">
<img src="img%2Fbas_example.png" alt="A diagram showing the steps in our British Antarctic Survey data pipeline to calculate and publish the Amundsen Sea Low Index dataset." width="100%"><p class="caption">
A diagram showing the steps in our British Antarctic Survey data
pipeline to calculate and publish the Amundsen Sea Low Index dataset.
</p>
</div>
<p>To generate the ASLI dataset, we read in ERA5 mean sea level
pressure, perform some calculations using the <code>asli</code> <a href="https://github.com/davidwilby/amundsen-sea-low-index" class="external-link">python
package</a> (Hosking &amp; Wilby), and move our results to the <a href="https://www.bas.ac.uk/data/uk-pdc/" class="external-link">UK Polar Data Centre
(PDC)</a>, where our dataset will be published and minted with a
<strong>Digital Object Identifier (DOI)</strong>. Our aim is to update
this dataset on a monthly basis, either appending new rows to it, or
re-writing the dataset entirely.</p>
<p>But remember, any change in previous ERA5 data, will also change the
results of all our previous ASLI calculations.</p>
<p>If this happened and we:</p>
<ul>
<li>
<em>overwrite our dataset</em>, we would be <strong>changing
values</strong> in an already-published dataset.</li>
<li>
<em>append our existing dataset</em>, anyone attempting to
<strong>reproduce</strong> our methods would get different results.</li>
</ul>
<p>Either way, this would invalidate our DOI and force
republication.</p>
<p>Keeping up-to-date with the <a href="https://forum.ecmwf.int/c/announcements/5" class="external-link">Climate Data Store’s
Forum</a> to monitor changes would be a time-consuming task, and not a
reliable way to detect changes.</p>
</div>
<div class="section level2">
<h2 id="verification-using-butterfly-in-a-pipeline">Verification using <code>butterfly</code> in a pipeline<a class="anchor" aria-label="anchor" href="#verification-using-butterfly-in-a-pipeline"></a>
</h2>
<p>To maintain the integrity of our published dataset, we need to impose
robust checks to ensure our new results match our published data, where
we expect it to.</p>
<div class="figure" style="text-align: center">
<img src="img%2Ffull_pipeline_example.png" alt="A diagram showing the steps in our British Antarctic Survey data pipeline to calculate and publish the Amundsen Sea Low Index dataset, while using butterfly to check for unexpected changes in our results." width="100%"><p class="caption">
A diagram showing the steps in our British Antarctic Survey data
pipeline to calculate and publish the Amundsen Sea Low Index dataset,
while using butterfly to check for unexpected changes in our results.
</p>
</div>
<p>… and this is where <code>butterfly</code> comes in.</p>
<p>When developing a pipeline, we separate our <strong>data</strong>,
<strong>configuration</strong> and <strong>code</strong>.</p>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>For the purpose of this article, details of the dataset itself are
not important. But for reference, below is a subset of the ASLI
dataset:</p>
<table class="table">
<colgroup>
<col width="15%">
<col width="10%">
<col width="10%">
<col width="15%">
<col width="15%">
<col width="15%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th align="left">time</th>
<th align="right">lon</th>
<th align="right">lat</th>
<th align="right">ActCenPres</th>
<th align="right">SectorPres</th>
<th align="right">RelCenPres</th>
<th align="left">DataSource</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">2024-01-01</td>
<td align="right">201.50</td>
<td align="right">-74.75</td>
<td align="right">979.0750</td>
<td align="right">985.1078</td>
<td align="right">-6.032776</td>
<td align="left">ERA5</td>
</tr>
<tr class="even">
<td align="left">2024-02-01</td>
<td align="right">258.75</td>
<td align="right">-70.00</td>
<td align="right">976.8563</td>
<td align="right">981.9796</td>
<td align="right">-5.123352</td>
<td align="left">ERA5</td>
</tr>
<tr class="odd">
<td align="left">2024-03-01</td>
<td align="right">190.75</td>
<td align="right">-71.25</td>
<td align="right">975.3262</td>
<td align="right">987.1877</td>
<td align="right">-11.861511</td>
<td align="left">ERA5</td>
</tr>
<tr class="even">
<td align="left">2024-04-01</td>
<td align="right">193.75</td>
<td align="right">-70.75</td>
<td align="right">970.4094</td>
<td align="right">980.2413</td>
<td align="right">-9.831970</td>
<td align="left">ERA5</td>
</tr>
</tbody>
</table>
<p>In the subsequent month we run the pipeline again, and a row is
added, because a new month of ERA5 data has since been released.</p>
<p>As you can see, all data for previous months are also included in the
data:</p>
<table class="table">
<colgroup>
<col width="15%">
<col width="10%">
<col width="10%">
<col width="15%">
<col width="15%">
<col width="15%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th align="left">time</th>
<th align="right">lon</th>
<th align="right">lat</th>
<th align="right">ActCenPres</th>
<th align="right">SectorPres</th>
<th align="right">RelCenPres</th>
<th align="left">DataSource</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">2024-01-01</td>
<td align="right">201.50</td>
<td align="right">-74.75</td>
<td align="right">979.0750</td>
<td align="right">985.1078</td>
<td align="right">-6.032776</td>
<td align="left">ERA5</td>
</tr>
<tr class="even">
<td align="left">2024-02-01</td>
<td align="right">258.75</td>
<td align="right">-70.00</td>
<td align="right">976.8563</td>
<td align="right">981.9796</td>
<td align="right">-5.123352</td>
<td align="left">ERA5</td>
</tr>
<tr class="odd">
<td align="left">2024-03-01</td>
<td align="right">190.75</td>
<td align="right">-71.25</td>
<td align="right">975.3262</td>
<td align="right">987.1877</td>
<td align="right">-11.861511</td>
<td align="left">ERA5</td>
</tr>
<tr class="even">
<td align="left">2024-04-01</td>
<td align="right">193.75</td>
<td align="right">-70.75</td>
<td align="right">970.4094</td>
<td align="right">980.2413</td>
<td align="right">-9.831970</td>
<td align="left">ERA5</td>
</tr>
<tr class="odd">
<td align="left">2024-05-01</td>
<td align="right">197.75</td>
<td align="right">-73.75</td>
<td align="right">969.6675</td>
<td align="right">986.0841</td>
<td align="right">-16.416565</td>
<td align="left">ERA5</td>
</tr>
</tbody>
</table>
<p>This is what will be submitted to the PDC.</p>
</div>
<div class="section level3">
<h3 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a>
</h3>
<p>Firstly let’s look at our configuration, which is stored in an
<code>ENVS</code> file. This determines the locations of our input data,
our output data and where we will eventually publish our data, among
other useful parameters.</p>
<p>If you are not familiar with an <code>ENVS</code> file, this is a
text file which exports environmental variables that subsequently be
used as part of a Bash shell script. Using an ENVS file is useful, as it
allows us to quickly change pipeline parameters, without altering the
code of the pipeline itself.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">## Directories</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co"># Should not need editing, but you can do so if you wish</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co"># Location that pipeline is stored, referenced by most scripts</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="bu">export</span> <span class="va">PIPELINE_DIRECTORY</span><span class="op">=</span><span class="va">$(</span> <span class="bu">cd</span> <span class="at">--</span> <span class="st">"</span><span class="va">$(</span> <span class="fu">dirname</span> <span class="at">--</span> <span class="st">"</span><span class="va">${BASH_SOURCE</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="va">}</span><span class="st">"</span> <span class="va">)</span><span class="st">"</span> <span class="op">&amp;&gt;</span> /dev/null <span class="kw">&amp;&amp;</span> <span class="bu">pwd</span> <span class="va">)</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co"># Set input and output directories for downloaded files (DATA_DIR) </span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co"># And calculation results (OUTPUT_DIR)</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="bu">export</span> <span class="va">DATA_DIR</span><span class="op">=</span><span class="va">${DATA_DIR</span><span class="op">:-</span><span class="va">${PIPELINE_DIRECTORY}</span>/data/ERA5/monthly<span class="va">}</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="bu">export</span> <span class="va">OUTPUT_DIR</span><span class="op">=</span><span class="va">${OUTPUT_DIR</span><span class="op">:-</span><span class="va">${PIPELINE_DIRECTORY}</span>/output<span class="va">}</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co"># Specify virtual environment so it does not need to be called prior to running</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="bu">export</span> <span class="va">ASLI_VENV</span><span class="op">=</span><span class="va">${ASLI_VENV</span><span class="op">:-</span><span class="va">${PIPELINE_DIRECTORY}</span>/asli_env/bin/activate<span class="va">}</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="co"># Setting rsync location, where we will eventually move our data should there </span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="co"># Be no errors</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="bu">export</span> <span class="va">RSYNC_LOCATION</span><span class="op">=</span><span class="st">""</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="co"># Set dates and current year for iteration purposes</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="bu">export</span> <span class="va">CURRENT_DATE</span><span class="op">=</span><span class="st">"</span><span class="kw">`</span><span class="fu">date</span> <span class="at">--utc</span> +<span class="st">"%Y_%m_%d"</span><span class="kw">`</span><span class="st">"</span></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="bu">export</span> <span class="va">CURRENT_YEAR</span><span class="op">=</span><span class="st">"</span><span class="kw">`</span><span class="fu">date</span> <span class="at">--utc</span> +<span class="st">"%Y"</span><span class="kw">`</span><span class="st">"</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a><span class="co">## Data querying parameters</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a><span class="co"># ERA5 Downloading parameters, we are only selecting the current year, for the </span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a><span class="co"># sake of computational efficiency</span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a><span class="bu">export</span> <span class="va">START_YEAR</span><span class="op">=</span>2024</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a><span class="bu">export</span> <span class="va">END_YEAR</span><span class="op">=</span><span class="va">${CURRENT_YEAR}</span></span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a><span class="bu">export</span> <span class="va">DATA_ARGS_ERA5</span><span class="op">=</span><span class="st">"-s </span><span class="va">${START_YEAR}</span><span class="st"> -n </span><span class="va">${CURRENT_YEAR}</span><span class="st">"</span></span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a><span class="co"># FILE_IDENTIFIER will what the output filename is called</span></span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a><span class="co"># ie asli_calculation_$FILE_IDENTIFIER.csv</span></span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a><span class="co"># Depending on how you are organising your files, you might want this </span></span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a><span class="co"># To be the CURRENT_YEAR, CURRENT_DATE or another unique ID</span></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a><span class="bu">export</span> <span class="va">FILE_IDENTIFIER</span><span class="op">=</span><span class="va">${CURRENT_YEAR}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="code">Code<a class="anchor" aria-label="anchor" href="#code"></a>
</h3>
<p>Now that we have set our configuration, let’s inspect the shell
script which actually runs our pipeline,
<code>run_asli_pipeline.sh</code>.</p>
<p>These scripts would be run in a Bash shell, e.g. to run this script
you would use <code>bash run_asli_pipeline.sh</code> in a terminal.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co"># Read in config file</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="bu">source</span> ENVS</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co"># Activate virtual environment</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="bu">source</span> <span class="va">${ASLI_VENV}</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co"># Put all relevant directories in a list</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="va">DIR_LIST</span><span class="op">=</span><span class="va">($DATA_DIR</span> <span class="va">$OUTPUT_DIR)</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="co"># Create them if they do not exist</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="cf">for</span> dir <span class="kw">in</span> <span class="va">${DIR_LIST</span><span class="op">[@]</span><span class="va">}</span><span class="kw">;</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="cf">do</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-d</span> <span class="va">$dir</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>    <span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$dir</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Created </span><span class="va">$dir</span><span class="st">"</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>  <span class="cf">fi</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>The above concerns setting up our pipeline with input and output
directories, as well as fetching all environmental variables, by
sourcing <code>ENVS</code>.</p>
<p>Next is the calculation step, using the functionality from the
<code>asli</code> package:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Fetch land sea mask, automatically writes in data directory</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co"># Everything is pre-set in asli functions, no arguments needed for our purpose</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="ex">asli_data_lsm</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co"># Downloading latest ERA5 data, provide information to the user</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Requesting with the following arguments: </span><span class="va">$DATA_ARGS_ERA5</span><span class="st">"</span>.</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="ex">asli_data_era5</span> <span class="va">$DATA_ARGS_ERA5</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co"># Run calculation, specifying output location</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="ex">asli_calc</span> <span class="va">$DATA_DIR</span>/era5_mean_sea_level_pressure_monthly_<span class="pp">*</span>.nc <span class="at">-o</span> <span class="va">$OUTPUT_DIR</span>/asli_calculation_<span class="va">$FILE_IDENTIFIER</span>.csv</span></code></pre></div>
<p>Lovely, we now have our calculations ready in
<code>$OUTPUT_DIR</code>, to rsync to a location given to us by the UK
Polar Data Centre (UK PDC). To do so for the first time, we will
run:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">rsync</span> <span class="va">$OUTPUT_DIR</span>/<span class="pp">*</span>.csv <span class="va">$RSYNC_LOCATION</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Writing to </span><span class="va">$RSYNC_LOCATION</span><span class="st">."</span></span></code></pre></div>
<p>Let’s pretend that this was our first submission to the UK PDC. For
any subsequent submission, we will want to use <code>butterfly</code> to
compare our new results with the file we have just submitted to the
<code>$RSYNC_LOCATION</code>, to make sure previous values have not
changed.</p>
<div class="section level4">
<h4 id="incorporate-r-and-butterfly-into-a-shell-scripted-pipeline">Incorporate R and <code>butterfly</code> into a shell-scripted
pipeline<a class="anchor" aria-label="anchor" href="#incorporate-r-and-butterfly-into-a-shell-scripted-pipeline"></a>
</h4>
<p>We are going to implement this in an R script called
<code>quality_control.R</code>, but we will have to provide it with our
new results and the results we submitted to the UK PDC, in the
<code>$RSYNC_LOCATION</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">Rscript</span> quality_control.R <span class="st">"</span><span class="va">$OUTPUT_DIR</span><span class="st">/asli_calculation_</span><span class="va">$FILE_IDENTIFIER</span><span class="st">.csv"</span> <span class="st">"</span><span class="va">$RSYNC_LOCATION</span><span class="st">/asli_calculation_</span><span class="va">$FILE_IDENTIFIER</span><span class="st">.csv"</span></span></code></pre></div>
<p>Here, <code>$OUTPUT_DIR/asli_calculation_$FILE_IDENTIFIER.csv</code>
is our most recent calculation, in <code>quality_control.R</code> this
will be referred to as <code>args[1]</code>. The previous calculation,
<code>$RSYNC_LOCATION/asli_calculation_$FILE_IDENTIFIER.csv</code>, will
be <code>args[2]</code>.</p>
<p>Let’s have a look at <code>quality_control.R</code> now. We start off
with making this script executable by the shell, provide the user with
some instructions on how to use the script, and by obtaining the
arguments it was given in <code>args</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#!/usr/bin/env Rscript</span></span>
<span><span class="co"># Usage: Rscript 02_quality_control.R &lt;current-file-path&gt; &lt;existing-file-path&gt;</span></span>
<span></span>
<span><span class="co"># Obtain passed arguments</span></span>
<span><span class="va">args</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html" class="external-link">commandArgs</a></span><span class="op">(</span>trailingOnly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Next, we will test if those arguments were actually provided, and if
so we read in our files:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Test if there is two arguments: the output and previous file</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">args</span><span class="op">)</span><span class="op">!=</span><span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span></span>
<span>    <span class="st">"Please provide the output file, and the file it is being compared to"</span>, call. <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span></span>
<span><span class="va">current_output</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">read_csv</span><span class="op">(</span></span>
<span>  <span class="va">args</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">existing_file</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">read_csv</span><span class="op">(</span></span>
<span>  <span class="va">args</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Great! Now that the files have been read in, we can start our
verification using <code>butterfly</code>.</p>
<p>In this case, we will use <code><a href="../reference/loupe.html">butterfly::loupe()</a></code> to give us
our report, and return either <code>TRUE</code> (previous data has not
changed, we are happy to proceed) or <code>FALSE</code> (a change in
previous data has been detected, and we should abort data transfer).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use butterfly to check there are no changes to past data</span></span>
<span><span class="va">qa_outcome</span> <span class="op">&lt;-</span> <span class="fu">butterfly</span><span class="fu">::</span><span class="fu"><a href="../reference/loupe.html">loupe</a></span><span class="op">(</span></span>
<span>  <span class="va">current_output</span>,</span>
<span>  <span class="va">existing_file</span>,</span>
<span>  datetime_variable <span class="op">=</span> <span class="st">"time"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">qa_outcome</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span></span>
<span>    <span class="st">"Previous values do not match. Stopping data transfer."</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The last check, <code>if (!isTRUE(qa_outcome))</code> will only
trigger and stop the entire pipeline if a change has been detected.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="the-whole-game">The whole game<a class="anchor" aria-label="anchor" href="#the-whole-game"></a>
</h2>
<p>We’ve inspected every bit of functionality in our pipeline, which can
be summarised as:</p>
<ol style="list-style-type: decimal">
<li>Reading in data, calculating asli values, and putting results in an
output folder.</li>
<li>Running verification checks on results in the output folder, and
comparing against those in the rsync location.</li>
<li>Transferring results from the output folder to the rsync location,
if verification checks have passed.</li>
</ol>
<p>A sensible way of organising distinct steps in a pipeline, is to move
different components of functionality into their own script. In our case
we will have:</p>
<ol style="list-style-type: decimal">
<li><code>01_run_asli_calculations.sh</code></li>
<li><code>02_quality_control.R</code></li>
<li>
<code>03_export_file_to_pdc.sh</code>.</li>
</ol>
<p>Finally, let’s update <code>run_asli_pipeline.sh</code> to make it
easier to read.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co"># Read in config file</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="bu">source</span> ENVS</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co"># Activate virtual environment</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="bu">source</span> <span class="va">${ASLI_VENV}</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="co"># Put all relevant directories in a list</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="va">DIR_LIST</span><span class="op">=</span><span class="va">($DATA_DIR</span> <span class="va">$OUTPUT_DIR)</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="co"># Create them if they do not exist</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="cf">for</span> dir <span class="kw">in</span> <span class="va">${DIR_LIST</span><span class="op">[@]</span><span class="va">}</span><span class="kw">;</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="cf">do</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-d</span> <span class="va">$dir</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>    <span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$dir</span></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Created </span><span class="va">$dir</span><span class="st">"</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>  <span class="cf">fi</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a><span class="co"># Run calculations, writes an output file in $OUTPUT_DIR</span></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a><span class="fu">bash</span> 01_run_asli_calculations.sh</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="co"># Check whether our new data has any changes from previously submitted data</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a><span class="ex">Rscript</span> 02_quality_control.R <span class="st">"</span><span class="va">$OUTPUT_DIR</span><span class="st">/asli_calculation_</span><span class="va">$FILE_IDENTIFIER</span><span class="st">.csv"</span> <span class="st">"</span><span class="va">$RSYNC_LOCATION</span><span class="st">/asli_calculation_</span><span class="va">$FILE_IDENTIFIER</span><span class="st">.csv"</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a><span class="co"># If successfuly, export our data to the PDC</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a><span class="fu">bash</span> 03_export_file_to_pdc.sh</span></code></pre></div>
<p>And there we are! Importantly, <code>02_quality_control.R</code>
should be run before <code>03_export_file_to_pdc.sh</code>.</p>
<p>Because <code>cli::cat_*()</code> warnings are used in
<code>butterfly</code>, these should print to the shell automatically
and allow you to diagnose where differences might have occurred.
<code>cli::cat_abort()</code> will automatically stop a pipeline.</p>
<p>Therefore, any failure in <code>02_quality_control.R</code> will
prevent our data from reaching its destination.</p>
</div>
<div class="section level2">
<h2 id="so-whats-next">So what’s next?<a class="anchor" aria-label="anchor" href="#so-whats-next"></a>
</h2>
<p>So, <code>butterfly</code> did its job, detected changes and stopped
data transfer… <em>now what?</em></p>
<p>Currently, it is set up to warn the user, who can intervene in the
process manually. The next step would be to make the published data
static, as we are now no longer appending it. We then supersede it with
our new data, and restart the process.</p>
<p>A future aim would be however, to do this automatically:</p>
<div class="figure" style="text-align: center">
<img src="img%2Fpipe_dream_diagram.png" alt="A diagram showing next steps in an automated data processing and publishing pipeline, incorporating automated archival and supserceding." width="100%"><p class="caption">
A diagram showing next steps in an automated data processing and
publishing pipeline, incorporating automated archival and supserceding.
</p>
</div>
<p>This is a lot more complex to handle however, especially considering
currently DOIs are minted manually, regardless of data state. Perhaps
some form of human intervention will always be required, but one can
dream!</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Hosking, J. S., A. Orr, T. J. Bracegirdle, and J. Turner (2016),
Future circulation changes off West Antarctica: Sensitivity of the
Amundsen Sea Low to projected anthropogenic forcing, Geophys. Res.
Lett., 43, 367–376, <a href="doi:10.1002/2015GL067143" class="uri">doi:10.1002/2015GL067143</a>.</p>
<p>Hosking, J. S., &amp; Wilby, D. asli [Computer software]. <a href="https://github.com/scotthosking/amundsen-sea-low-index" class="external-link uri">https://github.com/scotthosking/amundsen-sea-low-index</a></p>
<p>Zwagerman, T., &amp; Wilby, D. (2024). asli-pipeline (0.1.0). Zenodo.
<a href="https://doi.org/10.5281/zenodo.14552486" class="external-link uri">https://doi.org/10.5281/zenodo.14552486</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thomas Zwagerman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
