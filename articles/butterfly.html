<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>butterfly • butterfly</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="butterfly">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">butterfly</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/butterfly.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/butterfly_in_pipeline.html">Using butterfly in an operational data pipeline</a></li>
    <li><a class="dropdown-item" href="../articles/butterfly_paper.html">butterfly: An R package for the verification of continually updating timeseries data where we expect new values, but want to ensure previous data remains unchanged.</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ropensci/butterfly/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>butterfly</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/butterfly/blob/main/vignettes/butterfly.Rmd" class="external-link"><code>vignettes/butterfly.Rmd</code></a></small>
      <div class="d-none name"><code>butterfly.Rmd</code></div>
    </div>

    
    
<p>The goal of butterfly is to aid in the verification of continually
updating timeseries data, where we expect new values over time, but want
to ensure previous data remains unchanged, and timesteps remain
continuous.</p>
<p>Unnoticed changes in previous data could have unintended
consequences, such as invalidating DOIs, or altering future predictions
if used as input in forecasting models.</p>
<p>Other unnoticed changes could include a jump in time or measurement
frequency, due to instrument failure or software updates.</p>
<p>This package provides functionality that can be used as part of a
data pipeline, to check and flag changes to previous data to prevent
changes going unnoticed.</p>
<p>You can provide butterfly with a timeseries dataset to check for
continuity, with <code><a href="../reference/timeline.html">timeline()</a></code>, and if it is not fully
continuous as expected, split it into continuous chunks with
<code><a href="../reference/timeline_group.html">timeline_group()</a></code>. To check for changes to previous data,
you can provide two versions of the <em>same</em> dataset, and
<code><a href="../reference/loupe.html">loupe()</a></code> will check if there are changes to matching rows,
and tell you which rows are new. You can use <code><a href="../reference/catch.html">catch()</a></code> and
<code><a href="../reference/release.html">release()</a></code> to extract or remove rows with changes. Full
examples of functionality are provided below.</p>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>This packages includes a small dummy dataset,
<code>butterflycount</code>, which contains a list of monthly dataframes
of butterfly counts for a given date.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/butterfly" class="external-link">butterfly</a></span><span class="op">)</span></span>
<span><span class="va">butterflycount</span></span>
<span><span class="co">#&gt; $january</span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2024-01-01    22</span></span>
<span><span class="co">#&gt; 2 2023-12-01    55</span></span>
<span><span class="co">#&gt; 3 2023-11-01    11</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $february</span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2024-02-01    17</span></span>
<span><span class="co">#&gt; 2 2024-01-01    22</span></span>
<span><span class="co">#&gt; 3 2023-12-01    55</span></span>
<span><span class="co">#&gt; 4 2023-11-01    11</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $march</span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2024-03-01    23</span></span>
<span><span class="co">#&gt; 2 2024-02-01    17</span></span>
<span><span class="co">#&gt; 3 2024-01-01    22</span></span>
<span><span class="co">#&gt; 4 2023-12-01    55</span></span>
<span><span class="co">#&gt; 5 2023-11-01    18</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $april</span></span>
<span><span class="co">#&gt;         time value species</span></span>
<span><span class="co">#&gt; 1 2024-04-01    12 Admiral</span></span>
<span><span class="co">#&gt; 2 2024-03-01    23 Admiral</span></span>
<span><span class="co">#&gt; 3 2024-02-01    NA Admiral</span></span>
<span><span class="co">#&gt; 4 2024-01-01    22 Admiral</span></span>
<span><span class="co">#&gt; 5 2023-12-01    55 Admiral</span></span>
<span><span class="co">#&gt; 6 2023-11-01    18 Admiral</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $may</span></span>
<span><span class="co">#&gt;         time value species</span></span>
<span><span class="co">#&gt; 1 2024-05-01    70 Admiral</span></span>
<span><span class="co">#&gt; 2 2024-04-01    12 Admiral</span></span>
<span><span class="co">#&gt; 3 2024-03-01    23 Admiral</span></span>
<span><span class="co">#&gt; 4 2024-01-01    22 Admiral</span></span>
<span><span class="co">#&gt; 5 2024-12-01    55 Admiral</span></span>
<span><span class="co">#&gt; 6 2024-11-01    18 Admiral</span></span></code></pre></div>
<p>This dataset is entirely fictional, and merely included to aid in
demonstrating butterfly’s functionality.</p>
<p>Another dummy dataset, <code>forestprecipitation</code>, also
contains a list of monthly dataframes, but for fictional rainfall data.
This dataset is intended to illustrate an instance of instrument failure
leading to timesteps being recorded out of sync.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forestprecipitation</span></span>
<span><span class="co">#&gt; $january</span></span>
<span><span class="co">#&gt;         time rainfall_mm</span></span>
<span><span class="co">#&gt; 1 2024-01-01         0.0</span></span>
<span><span class="co">#&gt; 2 2024-01-02         2.6</span></span>
<span><span class="co">#&gt; 3 2024-01-03         0.0</span></span>
<span><span class="co">#&gt; 4 2024-01-04         0.0</span></span>
<span><span class="co">#&gt; 5 2024-01-05         3.7</span></span>
<span><span class="co">#&gt; 6 2024-01-06         0.8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $february</span></span>
<span><span class="co">#&gt;                  time rainfall_mm</span></span>
<span><span class="co">#&gt; 1 2024-02-01 00:00:00         1.1</span></span>
<span><span class="co">#&gt; 2 2024-02-02 00:00:00         0.0</span></span>
<span><span class="co">#&gt; 3 2024-02-03 00:00:00         1.4</span></span>
<span><span class="co">#&gt; 4 2024-02-04 00:00:00         2.2</span></span>
<span><span class="co">#&gt; 5 1969-12-31 23:00:00         3.4</span></span>
<span><span class="co">#&gt; 6 1970-01-01 23:00:00         0.6</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="examining-datasets-loupe">Examining datasets: <code>loupe()</code><a class="anchor" aria-label="anchor" href="#examining-datasets-loupe"></a>
</h2>
<p>We can use <code><a href="../reference/loupe.html">butterfly::loupe()</a></code> to examine in detail
whether previous values have changed.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">butterfly</span><span class="fu">::</span><span class="fu"><a href="../reference/loupe.html">loupe</a></span><span class="op">(</span></span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">february</span>,</span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">january</span>,</span>
<span>  datetime_variable <span class="op">=</span> <span class="st">"time"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">The following rows are new in 'df_current': </span></span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2024-02-01    17</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #00BB00;">And there are no differences with previous data.</span></span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="fu">butterfly</span><span class="fu">::</span><span class="fu"><a href="../reference/loupe.html">loupe</a></span><span class="op">(</span></span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">march</span>,</span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">february</span>,</span>
<span>  datetime_variable <span class="op">=</span> <span class="st">"time"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">The following rows are new in 'df_current': </span></span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2024-03-01    23</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #FFAF00;">ℹ</span> <span style="color: #FFAF00;">The following values have changes from the previous data.</span></span></span>
<span><span class="co">#&gt; old vs new</span></span>
<span><span class="co">#&gt;            <span style="font-weight: bold;">count</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[1, ]    17</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[2, ]    22</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[3, ]    55</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">- old[4, ]    18</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">+ new[4, ]    11</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; `old$count`: <span style="color: #555555;">17.0</span> <span style="color: #555555;">22.0</span> <span style="color: #555555;">55.0</span> <span style="color: #00BB00;">18.0</span></span></span>
<span><span class="co">#&gt; `new$count`: <span style="color: #555555;">17.0</span> <span style="color: #555555;">22.0</span> <span style="color: #555555;">55.0</span> <span style="color: #00BB00;">11.0</span></span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p><code><a href="../reference/loupe.html">butterfly::loupe()</a></code> uses <code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">dplyr::semi_join()</a></code>
to match the new and old objects using a common unique identifier, which
in a timeseries will be the timestep. <code><a href="https://waldo.r-lib.org/reference/compare.html" class="external-link">waldo::compare()</a></code> is
then used to compare these and provide a detailed report of the
differences.</p>
<p>In addition to a report, <code><a href="../reference/loupe.html">loupe()</a></code> also returns
<code>TRUE</code> if there are no differences and <code>FALSE</code>
when there are differences. This is especially useful when using
butterfly in a pipeline that runs in a shell environment, a check for
differences to fail gracefully.</p>
<p><code>butterfly</code> follows the <code>waldo</code> philosophy of
erring on the side of providing too much information, rather than too
little. It will give a detailed feedback message on the status between
two objects.</p>
<div class="section level3">
<h3 id="additional-arguments-from-waldocompare">Additional arguments from <code>waldo::compare()</code><a class="anchor" aria-label="anchor" href="#additional-arguments-from-waldocompare"></a>
</h3>
<p>You have the flexibility to pass further arguments accepted by
<code><a href="https://waldo.r-lib.org/reference/compare.html" class="external-link">waldo::compare()</a></code>to any of <code><a href="../reference/loupe.html">loupe()</a></code>,
<code><a href="../reference/catch.html">catch()</a></code> or <code><a href="../reference/release.html">release()</a></code>.</p>
<p>One such argument is <code>tolerance</code>. If we add a tolerance of
2 to the previous example, no differences should be returned:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">butterfly</span><span class="fu">::</span><span class="fu"><a href="../reference/loupe.html">loupe</a></span><span class="op">(</span></span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">march</span>,</span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">february</span>,</span>
<span>  datetime_variable <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>  tolerance <span class="op">=</span> <span class="fl">2</span> <span class="co"># &lt;- setting a tolerance of 2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">The following rows are new in 'df_current': </span></span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2024-03-01    23</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #00BB00;">And there are no differences with previous data.</span></span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>See <code>?waldo::compare()</code> for the full list of
arguments.</p>
</div>
</div>
<div class="section level2">
<h2 id="extracting-unexpected-changes-catch">Extracting unexpected changes: <code>catch()</code><a class="anchor" aria-label="anchor" href="#extracting-unexpected-changes-catch"></a>
</h2>
<p>You might want to return changed rows as a dataframe, instead of
returning <code>TRUE</code>/<code>FALSE</code>. For this
<code><a href="../reference/catch.html">butterfly::catch()</a></code>is provided.</p>
<p><code><a href="../reference/catch.html">butterfly::catch()</a></code> only returns rows which have
<strong>changed</strong> from the previous version. It will not return
new rows.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_caught</span> <span class="op">&lt;-</span> <span class="fu">butterfly</span><span class="fu">::</span><span class="fu"><a href="../reference/catch.html">catch</a></span><span class="op">(</span></span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">march</span>,</span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">february</span>,</span>
<span>  datetime_variable <span class="op">=</span> <span class="st">"time"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">The following rows are new in 'df_current': </span></span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2024-03-01    23</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #FFAF00;">ℹ</span> <span style="color: #FFAF00;">The following values have changes from the previous data.</span></span></span>
<span><span class="co">#&gt; old vs new</span></span>
<span><span class="co">#&gt;            <span style="font-weight: bold;">count</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[1, ]    17</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[2, ]    22</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[3, ]    55</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">- old[4, ]    18</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">+ new[4, ]    11</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; `old$count`: <span style="color: #555555;">17.0</span> <span style="color: #555555;">22.0</span> <span style="color: #555555;">55.0</span> <span style="color: #00BB00;">18.0</span></span></span>
<span><span class="co">#&gt; `new$count`: <span style="color: #555555;">17.0</span> <span style="color: #555555;">22.0</span> <span style="color: #555555;">55.0</span> <span style="color: #00BB00;">11.0</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #FFAF00;">ℹ</span> <span style="color: #FFAF00;">Only these rows are returned.</span></span></span>
<span></span>
<span><span class="va">df_caught</span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2023-11-01    18</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="dropping-unexpected-changes-release">Dropping unexpected changes: <code>release()</code><a class="anchor" aria-label="anchor" href="#dropping-unexpected-changes-release"></a>
</h2>
<p>Conversely, <code><a href="../reference/release.html">butterfly::release()</a></code> drops all rows which
have changed from the previous version. Note it retains new rows, as
these were expected.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_released</span> <span class="op">&lt;-</span> <span class="fu">butterfly</span><span class="fu">::</span><span class="fu"><a href="../reference/release.html">release</a></span><span class="op">(</span></span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">march</span>,</span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">february</span>,</span>
<span>  datetime_variable <span class="op">=</span> <span class="st">"time"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">The following rows are new in 'df_current': </span></span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2024-03-01    23</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #FFAF00;">ℹ</span> <span style="color: #FFAF00;">The following values have changes from the previous data.</span></span></span>
<span><span class="co">#&gt; old vs new</span></span>
<span><span class="co">#&gt;            <span style="font-weight: bold;">count</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[1, ]    17</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[2, ]    22</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[3, ]    55</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">- old[4, ]    18</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">+ new[4, ]    11</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; `old$count`: <span style="color: #555555;">17.0</span> <span style="color: #555555;">22.0</span> <span style="color: #555555;">55.0</span> <span style="color: #00BB00;">18.0</span></span></span>
<span><span class="co">#&gt; `new$count`: <span style="color: #555555;">17.0</span> <span style="color: #555555;">22.0</span> <span style="color: #555555;">55.0</span> <span style="color: #00BB00;">11.0</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #FFAF00;">ℹ</span> <span style="color: #FFAF00;">These will be dropped, but new rows are included.</span></span></span>
<span></span>
<span><span class="va">df_released</span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2024-03-01    23</span></span>
<span><span class="co">#&gt; 2 2024-02-01    17</span></span>
<span><span class="co">#&gt; 3 2024-01-01    22</span></span>
<span><span class="co">#&gt; 4 2023-12-01    55</span></span></code></pre></div>
<p>However, you do have the option to exclude new rows as well with the
argument <code>include_new</code> set to <code>FALSE</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_release_without_new</span> <span class="op">&lt;-</span> <span class="fu">butterfly</span><span class="fu">::</span><span class="fu"><a href="../reference/release.html">release</a></span><span class="op">(</span></span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">march</span>,</span>
<span>  <span class="va">butterflycount</span><span class="op">$</span><span class="va">february</span>,</span>
<span>  datetime_variable <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>  include_new <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">The following rows are new in 'df_current': </span></span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2024-03-01    23</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #FFAF00;">ℹ</span> <span style="color: #FFAF00;">The following values have changes from the previous data.</span></span></span>
<span><span class="co">#&gt; old vs new</span></span>
<span><span class="co">#&gt;            <span style="font-weight: bold;">count</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[1, ]    17</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[2, ]    22</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  old[3, ]    55</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">- old[4, ]    18</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">+ new[4, ]    11</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; `old$count`: <span style="color: #555555;">17.0</span> <span style="color: #555555;">22.0</span> <span style="color: #555555;">55.0</span> <span style="color: #00BB00;">18.0</span></span></span>
<span><span class="co">#&gt; `new$count`: <span style="color: #555555;">17.0</span> <span style="color: #555555;">22.0</span> <span style="color: #555555;">55.0</span> <span style="color: #00BB00;">11.0</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #FFAF00;">ℹ</span> <span style="color: #FFAF00;">These will be dropped, along with new rows.</span></span></span>
<span></span>
<span><span class="va">df_release_without_new</span></span>
<span><span class="co">#&gt;         time count</span></span>
<span><span class="co">#&gt; 1 2024-02-01    17</span></span>
<span><span class="co">#&gt; 2 2024-01-01    22</span></span>
<span><span class="co">#&gt; 3 2023-12-01    55</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="checking-for-continuity-timeline">Checking for continuity: <code>timeline()</code><a class="anchor" aria-label="anchor" href="#checking-for-continuity-timeline"></a>
</h2>
<p>To check if a timeseries is continuous, <code><a href="../reference/timeline.html">timeline()</a></code> and
<code><a href="../reference/timeline_group.html">timeline_group()</a></code> are provided. Even if a timeseries does
not contain obvious gaps, this does not automatically mean it is also
continuous.</p>
<p>Measuring instruments can have different behaviours when they fail.
For example, during power failure an internal clock could reset to
“1970-01-01”, or the manufacturing date (e.g. “2021-01-01”, this is
common behaviour for Raspberry Pi’s). This leads to unpredictable ways
of checking if a dataset is continuous.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A rain gauge which measures precipitation every day</span></span>
<span><span class="fu">butterfly</span><span class="fu">::</span><span class="va"><a href="../reference/forestprecipitation.html">forestprecipitation</a></span><span class="op">$</span><span class="va">january</span></span>
<span><span class="co">#&gt;         time rainfall_mm</span></span>
<span><span class="co">#&gt; 1 2024-01-01         0.0</span></span>
<span><span class="co">#&gt; 2 2024-01-02         2.6</span></span>
<span><span class="co">#&gt; 3 2024-01-03         0.0</span></span>
<span><span class="co">#&gt; 4 2024-01-04         0.0</span></span>
<span><span class="co">#&gt; 5 2024-01-05         3.7</span></span>
<span><span class="co">#&gt; 6 2024-01-06         0.8</span></span>
<span></span>
<span><span class="co"># In February there is a power failure in the instrument</span></span>
<span><span class="fu">butterfly</span><span class="fu">::</span><span class="va"><a href="../reference/forestprecipitation.html">forestprecipitation</a></span><span class="op">$</span><span class="va">february</span></span>
<span><span class="co">#&gt;                  time rainfall_mm</span></span>
<span><span class="co">#&gt; 1 2024-02-01 00:00:00         1.1</span></span>
<span><span class="co">#&gt; 2 2024-02-02 00:00:00         0.0</span></span>
<span><span class="co">#&gt; 3 2024-02-03 00:00:00         1.4</span></span>
<span><span class="co">#&gt; 4 2024-02-04 00:00:00         2.2</span></span>
<span><span class="co">#&gt; 5 1969-12-31 23:00:00         3.4</span></span>
<span><span class="co">#&gt; 6 1970-01-01 23:00:00         0.6</span></span></code></pre></div>
<p>To check if a timeseries is continuous:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">butterfly</span><span class="fu">::</span><span class="fu"><a href="../reference/timeline.html">timeline</a></span><span class="op">(</span></span>
<span>   <span class="va">forestprecipitation</span><span class="op">$</span><span class="va">january</span>,</span>
<span>   datetime_variable <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>   expected_lag <span class="op">=</span> <span class="fl">1</span></span>
<span> <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #00BB00;">There are no time lags which are greater than the expected lag: 1 days. By this measure, the timeseries is continuous.</span></span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>As expected January is a continuous dataset, where there is no more
than a difference of 1 day between timesteps.</p>
<p>However, in February our imaginary rain gauge’s onboard computer had
a failure.</p>
<p>The timestamp was reset to <code>1970-01-01</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forestprecipitation</span><span class="op">$</span><span class="va">february</span></span>
<span><span class="co">#&gt;                  time rainfall_mm</span></span>
<span><span class="co">#&gt; 1 2024-02-01 00:00:00         1.1</span></span>
<span><span class="co">#&gt; 2 2024-02-02 00:00:00         0.0</span></span>
<span><span class="co">#&gt; 3 2024-02-03 00:00:00         1.4</span></span>
<span><span class="co">#&gt; 4 2024-02-04 00:00:00         2.2</span></span>
<span><span class="co">#&gt; 5 1969-12-31 23:00:00         3.4</span></span>
<span><span class="co">#&gt; 6 1970-01-01 23:00:00         0.6</span></span>
<span></span>
<span><span class="fu">butterfly</span><span class="fu">::</span><span class="fu"><a href="../reference/timeline.html">timeline</a></span><span class="op">(</span></span>
<span>  <span class="va">forestprecipitation</span><span class="op">$</span><span class="va">february</span>,</span>
<span>   datetime_variable <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>   expected_lag <span class="op">=</span> <span class="fl">1</span></span>
<span> <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #FFAF00;">ℹ</span> <span style="color: #FFAF00;">There are time lags which are greater than the expected lag: 1 days. This indicates the timeseries is not continuous. There are 2 distinct continuous sequences. Use `timeline_group()` to extract.</span></span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="grouping-distinct-continuous-sequences-timeline_group">Grouping distinct continuous sequences:
<code>timeline_group()</code><a class="anchor" aria-label="anchor" href="#grouping-distinct-continuous-sequences-timeline_group"></a>
</h2>
<p>If we wanted to group chunks of our timeseries that are distinct, or
broken up in some way, but still continuous, we can use
<code><a href="../reference/timeline_group.html">timeline_group()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">butterfly</span><span class="fu">::</span><span class="fu"><a href="../reference/timeline_group.html">timeline_group</a></span><span class="op">(</span></span>
<span>  <span class="va">forestprecipitation</span><span class="op">$</span><span class="va">february</span>,</span>
<span>   datetime_variable <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>   expected_lag <span class="op">=</span> <span class="fl">1</span></span>
<span> <span class="op">)</span></span>
<span><span class="co">#&gt;                  time rainfall_mm        timelag timeline_group</span></span>
<span><span class="co">#&gt; 1 2024-02-01 00:00:00         1.1        NA days              1</span></span>
<span><span class="co">#&gt; 2 2024-02-02 00:00:00         0.0      1.00 days              1</span></span>
<span><span class="co">#&gt; 3 2024-02-03 00:00:00         1.4      1.00 days              1</span></span>
<span><span class="co">#&gt; 4 2024-02-04 00:00:00         2.2      1.00 days              1</span></span>
<span><span class="co">#&gt; 5 1969-12-31 23:00:00         3.4 -19757.04 days              2</span></span>
<span><span class="co">#&gt; 6 1970-01-01 23:00:00         0.6      1.00 days              2</span></span></code></pre></div>
<p>We now have groups 1 &amp; 2, which are both continuous sets of data,
but there is no continuity between them.</p>
</div>
<div class="section level2">
<h2 id="using-butterfly-in-a-data-processing-pipeline">Using <code>butterfly</code> in a data processing pipeline<a class="anchor" aria-label="anchor" href="#using-butterfly-in-a-data-processing-pipeline"></a>
</h2>
<p>If you would like to know more about using <code>butterfly</code> in
an operational data processing pipeline, please refer to the article on
<a href="https://thomaszwagerman.github.io/butterfly/articles/butterfly_in_pipeline.html">using
<code>butterfly</code> in an operational pipeline</a>.</p>
</div>
<div class="section level2">
<h2 id="a-note-on-controlling-verbosity">A note on controlling verbosity<a class="anchor" aria-label="anchor" href="#a-note-on-controlling-verbosity"></a>
</h2>
<p>Although verbosity is mostly the purpose if this package,
<strong>should</strong> you wish to silence messages and warnings, you
can do so with <code>options(rlib_message_verbosity = "quiet")</code>
and options <code>(rlib_warning_verbosity = "quiet")</code>.</p>
</div>
<div class="section level2">
<h2 id="rationale">Rationale<a class="anchor" aria-label="anchor" href="#rationale"></a>
</h2>
<p>There are a lot of other data comparison and QA/QC packages out
there, why butterfly?</p>
<div class="section level3">
<h3 id="unexpected-changes-in-models">Unexpected changes in models<a class="anchor" aria-label="anchor" href="#unexpected-changes-in-models"></a>
</h3>
<p>This package was originally developed to deal with <a href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels?tab=documentation" class="external-link">ERA5</a>’s
initial release data, ERA5T. ERA5T data for a month is overwritten with
the final ERA5 data two months after the month in question.</p>
<p>Usually ERA5 and ERA5T are identical, but occasionally an issue with
input data can (for example for <a href="https://confluence.ecmwf.int/display/CKB/ERA5T+issue+in+snow+depth" class="external-link">09/21
- 12/21</a>, and <a href="https://forum.ecmwf.int/t/final-validated-era5-product-to-differ-from-era5t-in-july-2024/6685" class="external-link">07/24</a>)
force a recalculation, meaning previously published data differs from
the final product.</p>
<p>When publishing ERA5-derived datasets, and minting it with a DOI, it
is possible to continuously append without invalidating that DOI.
However, recalculation would overwrite previously published data,
thereby forcing a new publication and DOI to be minted.</p>
<p>We use the functionality in this package in an automated data
processing pipeline to detect changes, stop data transfer and notify the
user.</p>
</div>
<div class="section level3">
<h3 id="unexpected-changes-in-data-acquisition">Unexpected changes in data acquisition<a class="anchor" aria-label="anchor" href="#unexpected-changes-in-data-acquisition"></a>
</h3>
<p>Measuring instruments can have different behaviours when they have a
power failure. For example, during power failure an internal clock could
reset to “1970-01-01”, or the manufacturing date (say, “2021-01-01”). If
we are automatically ingesting and processing this data, it would be
great to get a head’s up that a timeseries is no longer continuous in
the way we expect it to be. This could have consequences for any
calculation happening downstream.</p>
<p>To prevent writing different ways of checking for this depending on
the instrument, we wrote <code><a href="../reference/timeline.html">butterfly::timeline()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="variable-measurement-frequencies">Variable measurement frequencies<a class="anchor" aria-label="anchor" href="#variable-measurement-frequencies"></a>
</h3>
<p>In other cases, a non-continuous timeseries is intentional, for
example when there is temporal variability in the measurements taken
depending on events. At BAS, we collect data from a penguin weighbridge
on Bird Island, South Georgia. This weighbridge measure weight on two
different load cells (scales), one on the colony side and one on the
ocean side, to determine penguin weight and the direction they came
from. The idea is that we may be able to derive information on their
diet, as they return from the ocean to the colony.</p>
<p>You can read about this work in more detail in <a href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0126292" class="external-link">Afanasyev
et al. (2015)</a>, but the important point here is that the weighbridge
does not collect continuous measurements. In a remote, off-grid location
this would drain batteries far too quickly.</p>
<p>Therefore, when no weight is detected on the load cells it only
samples at 1hz, but as soon as any change in weight is detected it will
start collecting data at 100hz. This is of course intentional, to reduce
the sheer volume of data we need to process, but also has another
benefit in isolating (or attempting to) individual crossings.</p>
<p>The individual crossings are the most valuables pieces of data, as
these allow us to deduce information on weight, direction and
ultimately, diet.</p>
<p>In this case separating distinct, but continuous segments of data is
required. This is the reasoning behind <code><a href="../reference/timeline_group.html">timeline_group()</a></code>.
This function allows us to split our timeseries in groups of individual
crossings.</p>
</div>
<div class="section level3">
<h3 id="in-summary">In summary<a class="anchor" aria-label="anchor" href="#in-summary"></a>
</h3>
<p>This package has intentionally been generalised to accommodate other,
but similar, use cases. Other examples could include a correction in
instrument calibration, compromised data transfer or unnoticed changes
in the parameterisation of a model.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thomas Zwagerman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
